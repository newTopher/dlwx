window.alert=function(b){var a=($("body").width()-$("#attentionMsg").width())/2;$("#attentionMsg").css("left",a+"px");$("#attentionMsg p").text(b);$("#attentionMsg").fadeIn("slow",function(){setTimeout(function(){$("#attentionMsg").fadeOut("slow");},1500);});};function showLoading(){$.mobile.loading("show");}function hideLoading(){$.mobile.loading("hide");}function fetchMenuOnPanel(a){$("#category").val(a);$("#pageNo").val(0);fetchNextMenuPage("panel");}function fetchNextMenuPage(d){var c=$("#category").val();showLoading();var a=$("#siteContextPath").val();$("#fetchNextPageMenuStatus").val(1);var b=$("#pageNo").val();if(!b){b=0;$("#pageNo").val(b);}b=b*1+1;$.post(a+"/wx/menu/list.wx",{currentPage:b,category:c},function(e){hideLoading();if(e=="1029"){alert("页面停留过久，请重新进入");}else{if(e=="1036"){alert("加载失败，请重试");}else{if(e=="暂无菜单哦"){if(d=="panel"){alert("没有商品哦");}else{if(d=="more"){alert("没有更多了");$("#loadMore").hide();}}}else{if(d=="panel"){$("#main_context").html(e);$("#loadMore").show();}else{if(d=="more"){$("#main_context").append(e);}}$("#main_context").listview("refresh");$("#main_context").find(".plus,.minus").buttonMarkup("refresh");recalculateEachMenuCount();$("#fetchNextPageMenuStatus").val(0);}}}});}function addGoodsToCart(g,b,f){if(b==0){$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList'][value='"+g+"']").eq(0).remove();$("#menu_id_list_ctx_menuList").find("input[name='menuIdList'][value='"+g+"']").eq(0).remove();}else{if(b==1){$("#menu_id_list_ctx_menuConfirm").append('<input type="hidden" name="menuIdList" value="'+g+'"/>');$("#menu_id_list_ctx_menuList").append('<input type="hidden" name="menuIdList" value="'+g+'"/>');}}$("#shopingCartCount").html($("#menu_id_list_ctx_menuList").find("input[name='menuIdList']").length);if(f=="confirm"||f=="updateFeeWhenInit"){var e=0;$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']").each(function(){e+=$("#menu_price_"+$(this).val()).val()*1;});var a=recalculateTakeoutFee();var c="";if(a.fee>0){if(e>0){e+=a.fee;c="，含"+a.fee+"元"+a.name;}}e=e.toFixed(2);if(validateMinBookMoney()){$("#totalAmount").html(e+"元"+c);}else{$("#totalAmount").html(e+"元，不满起送价"+c);}}var d=0;if($("#menu_id_list_ctx_menuList").length>0){d=$("#menu_id_list_ctx_menuList").find("input[name='menuIdList'][value='"+g+"']").length;}else{if($("#menu_id_list_ctx_menuConfirm").length>0){d=$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList'][value='"+g+"']").length;}}if(d>0){$("#thsMenuCount_"+g).html(d);$("#thsMenuCount_"+g).show();$("#thsConfirmMenuCount_"+g).html(d);$("#thsConfirmMenuCount_"+g).show();}else{$("#thsMenuCount_"+g).html("");$("#thsMenuCount_"+g).hide();if(f=="confirm"){$("#confirmMenuId_"+g).remove();$("#confirmOrderListCtx").listview("refresh");}}if(f!="updateCountWhenInit"&&f!="updateFeeWhenInit"){updateCookieForShopingCart();}}function updateCookieForShopingCart(){var c="";var b=null;if($("#menu_id_list_ctx_menuList").length>0){b=$("#menu_id_list_ctx_menuList").find("input[name='menuIdList']");}else{if($("#menu_id_list_ctx_menuConfirm").length>0){b=$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']");}}b.each(function(){c+="&menuIdList="+$(this).val();});if(c!=""){c=c.substring(1,c.length);}var a=$("#siteContextPath").val();$.get(a+"/wx/order/cookie/update.wx?"+c);}function recalculateEachMenuCount(){var a=null;if($("#menu_id_list_ctx_menuList").length>0){a=$("#menu_id_list_ctx_menuList").find("input[name='menuIdList']");}else{if($("#menu_id_list_ctx_menuConfirm").length>0){a=$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']");}}a.each(function(){addGoodsToCart($(this).val(),0,"updateCountWhenInit");if($("#isOutOfSales_"+$(this).val()).val()!="true"){addGoodsToCart($(this).val(),1,"updateCountWhenInit");}});}function recalculateTakeoutFee(){var b=$("#isNeedTakeoutFee").val();var a=$("#takeoutFeeName").val();var c=$("#takeoutFeeType").val();var e=$("#takeoutFeeValue").val()*1;var d=0;if(b=="Y"){if(c=="1"){d=e;}else{if(c=="2"){$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']").each(function(){d+=e;});}}}return{fee:d,name:a};}function validateMinBookMoney(){var c=$("#minBookPrice").val()*1;var b=$("#extraPrice").val()*1;if(c<=0||b<=0){return true;}var a=0;$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']").each(function(){a+=$("#menu_price_"+$(this).val()).val()*1;});return a>=c;}function showVerifyCodeBtn(){$("#verifyCode_li").show();$("#verifyCodeBtn_li").show();}function checkIsShouldVerifyCode(c){if(!validateNumber(c)){alert("请填写正确的"+$("#customerTelephone").attr("placeholder"));return;}var b=$("#origPhoneNumber").val();var a=$("#isShouldVerifyWhenChangePhone").val();if(a=="true"){if($.trim(c)!=$.trim(b)){showVerifyCodeBtn();}else{$("#verifyCodeBtn_li").hide();$("#verifyCode_li").hide();}}}function validateCustomer(){var a=$("#customerName").val();var e=$("#customerAddress").val();var g=$("#customerTelephone").val();var c=$("#verifyCode").val();if($("#customerName").length>0&&(a==null||a=="")){alert($("#customerName").attr("placeholder")+"不能为空");return false;}if($("#customerAddress").length>0&&(e==null||e=="")){alert($("#customerAddress").attr("placeholder")+"不能为空");return false;}if($("#customerTelephone").length>0&&(g==null||g=="")){alert($("#customerTelephone").attr("placeholder")+"不能为空");return false;}if($("#customerName").length>0&&a.length>32){alert($("#customerName").attr("placeholder")+"不能超过32个字符");return false;}if($("#customerAddress").length>0&&e.length>64){alert($("#customerAddress").attr("placeholder")+"不能超过64个字符");return false;}if($("#customerTelephone").length>0&&g.length>32){alert($("#customerTelephone").attr("placeholder")+"不能超过32个字符");return false;}if($("#customerTelephone").length>0&&!validateNumber(g)){alert("请填写正确的"+$("#customerTelephone").attr("placeholder"));return false;}if($("#verifyCode_li").is(":visible")){if(c==""||c==null){alert("验证码不能为空");return false;}if(c.length>6){alert("验证码长度不能超过6位");return false;}}var f=$("input[customField='true']");for(var b=0;b<f.length;b++){var d=$(f[b]);if(!d.is(":hidden")&&d.attr("notNull")=="Y"&&d.val()==""){alert(d.attr("placeholder")+"不能为空");return false;}}return true;}function validateNumber(b){if(b==""){return false;}var a=new RegExp("^[0-9]*$");return a.test(b);}function retrieveSmsVerifyCode(){var c=$("#customerTelephone").val();if(!validateNumber(c)){alert("请填写正确的"+$("#customerTelephone").attr("placeholder"));return;}if($("#verifyPhoneButton").attr("isSending")=="0"){alert("正在发送，请稍后！");return;}if(typeof(smsCheckCodeTimeOutValue)!="undefined"&&smsCheckCodeTimeOutValue>0){alert("请"+smsCheckCodeTimeOutValue+"秒后再获取！");}else{$("#verifyPhoneButton").text("正在发送");$("#verifyPhoneButton").attr("isSending","0");showLoading();var b=$("#siteContextPath").val();var a=b+"/wx/verifyCode/sms/send.wx?phone="+c;$.get(a,function(d){hideLoading();$("#verifyPhoneButton").attr("isSending","1");if(d=="1"){alert("你的号码错误！");$("#verifyPhoneButton").text("获取验证码");return;}else{if(d=="2"){alert("每30秒只能获取一次！");$("#verifyPhoneButton").text("获取验证码");return;}else{if(d=="3"){alert("你获取验证码的次数太多了,休息一下吧！");$("#verifyPhoneButton").text("获取验证码");return;}else{if(d=="success"){alert("验证码已经发送到你的手机，请查收！");var e=function(){if(smsCheckCodeTimeOutValue<=0){$("#verifyPhoneButton").text("获取验证码");return;}smsCheckCodeTimeOutValue-=1;$("#verifyPhoneButton").text(smsCheckCodeTimeOutValue+"秒后再获取");setTimeout(e,1000);};smsCheckCodeTimeOutValue=61;e();return;}else{if(d=="fail"){alert("短信发送失败，请重试！");$("#verifyPhoneButton").text("获取验证码");return;}}}}}});}}function confirmSubmitOrder(){if($("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']").length<=0){alert("您暂时没有选择商品哦");}else{if(validateCustomer()&&valudateScore()){var b=0;$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']").each(function(){b+=$("#menu_price_"+$(this).val()).val()*1;});var a=$("input[name='isUsePayCoupon']:checked").val();if(a==1){var c=$("input[name='customerCouponId']:checked").attr("minConsume")*1;if(b<c){if(confirm("此优惠券需要最低消费"+c+"元，您的消费金额不够，需要继续提交订单吗？")){$("#usePayCoupon").attr("checked",false).checkboxradio("refresh");$("#noUsePayCoupon").attr("checked",true).checkboxradio("refresh");$("#availableCouponText").hide();validateShopMemberSubmit(b);}}else{validateShopMemberSubmit(b);}}else{validateShopMemberSubmit(b);}}}}function validateShopMemberSubmit(b){var a=$("input[name='orderPayType']:checked").val();if(a==2){var c=$("#availablePayMoney").val();if(!c){return;}if(c==-1){if(confirm("你还不是店铺会员,不能使用余额付款,要继续提交订单吗？")){$("#payWhenGoodsCome").attr("checked",true);validateOrderForm();}}else{if(b>c){if(c==0){if(confirm("你的余额为0元,不能使用余额付款,要继续提交订单吗？")){$("#payWhenGoodsCome").attr("checked",true);validateOrderForm();}}else{if(confirm("你的余额已不足,剩余金额需要使用货到付款，要继续提交订单吗？")){validateOrderForm();}}}else{validateOrderForm();}}}else{validateOrderForm();}}function validateOrderForm(){if(validateMinBookMoney()){if(validateCurrentWorkTime()){submitOrderForm();}else{if(confirm("现在是店铺的非营业时间段，店主可能无法及时受理您的订单，确定要提交吗？")){submitOrderForm();}}}else{if(confirm("您的订单总价不满该店最低起送价,需要额外支付"+$("#extraPrice").val()+"元，确定要提交吗？")){if(validateCurrentWorkTime()){submitOrderForm();}else{if(confirm("现在是店铺的非营业时间段，店主可能无法及时受理您的订单，确定要提交吗？")){submitOrderForm();}}}}}function validateCurrentWorkTime(){var a=new Date().getHours();var c=new Date().getMinutes();var b=a*60+c;var e=$("#shopStartWorkTime").val()*1;var d=$("#shopEndWorkTime").val()*1;if(d-24*60>=0){return b>e||b<(d-24*60);}else{return(b>e)&&(b<d);}}function submitOrderForm(){var d={"customer.name":$("#customerName").val(),"customer.address":$("#customerAddress").val(),"customer.telephone":$("#customerTelephone").val(),"verifyCode":$("#verifyCode").val(),"comment":$("#remarks").val(),"orderPayType":$("input[name='orderPayType']:checked").val()};var e=$("input[customField='true'],select[customField='true']");for(var b=0;b<e.length;b++){var c=$(e[b]);d[c.attr("name")]=c.val();}if($("input[name='isUsePayCoupon']:checked").val()==1){d.isUsePayCoupon=1;d.customerCouponId=$("input[name='customerCouponId']:checked").val();
}if($("input[name='isUsePayScore']:checked").val()==1){d.isUsePayScore=1;d.useScoreValue=$("#useScoreValue").val();}var a=$("#siteContextPath").val()+"/wx/order/submit.wx?rand="+(new Date().getTime());$("#menu_id_list_ctx_menuConfirm").find("input[name='menuIdList']").each(function(){a+="&menuIdList="+$(this).val();});showLoading();$.mobile.changePage(a,{type:"post",data:d,changeHash:false,transition:"none",role:"dialog",showLoadMsg:true});}function submitOrderSuccessCallback(){$("#menu_id_list_ctx_menuConfirm").html("");$("#menu_id_list_ctx_menuList").html("");$("#confirmOrderListCtx").html("");$("#shopingCartCount").html("0");$("#main_context").find("span[id^='thsMenuCount_']").hide();$("#totalAmount").html("0元");}function fetchNextOrderPage(){showLoading();var a=$("#siteContextPath").val();var b=$("#pageNo").val();if(!b){b=0;$("#pageNo").val(b);}b=b*1+1;$.post(a+"/wx/order/list.wx",{currentPage:b,orderStatus:$("#orderStatus").val()},function(c){hideLoading();if(c=="1029"){alert("页面停留过久，请重新进入");}else{if(c=="1036"){alert("加载失败，请重试");}else{if(c.indexOf("暂无订单")>-1){alert("没有更多了");$("#loadMore").hide();}else{$("#order_data_result").append(c);$("#order_data_result").find("a[data-role='button']").not(".ui-link").button().button("refresh");$("#order_list_table").table-columntoggle("refresh");}}}});}function submitUserInfo(){if(validateCustomer()){showLoading();var b=$("#siteContextPath").val();var a=b+"/wx/customer/update.wx";var c={"customer.name":$("#customerName").val(),"customer.address":$("#customerAddress").val(),"customer.telephone":$("#customerTelephone").val(),"verifyCode":$("#verifyCode").val()};$.post(a,c,function(d){hideLoading();if(d=="0"){alert("修改成功");}else{if(d=="1"){alert("请输入验证码");$("#verifyCodeBtn_li").show();$("#verifyCode_li").show();}else{if(d=="2"){alert("验证码错误");}}}});}}function createShopMember(){showLoading();var a=$("#siteContextPath").val();$.post(a+"/wx/shop/member/create.wx?rand="+(new Date().getTime()),function(b){hideLoading();if(b.ret){if(b.ret=="0"){alert("开通成功!");showLoading();window.location.reload();}else{if(b.ret=="1"){alert("此店铺没有开启会员功能!");}else{if(b.ret=="2"){alert("此店铺没有开启累积消费开通会员!");}else{if(b.ret=="3"){alert("您的累计消费金额不满"+b.total+"元，无法开通!");}else{if(b.ret=="4"){alert("您已经是会员了，不能重复开通!");}}}}}}},"json");}function changePayType(b){if(b==1){$("#availablePayMoneyText").hide();}else{if(b==2){$("#availablePayMoneyText").show();if(!$("#availablePayMoney").val()){var a=$("#siteContextPath").val();showLoading();$.get(a+"/wx/shop/member/info/retrieve.wx",function(c){hideLoading();if(c.ret==0){$("#availablePayMoneyText p").text("您不是该店铺的会员，无法使用余额支付！");$("#availablePayMoney").val(-1);}else{if(c.ret==1){$("#availablePayMoneyText p").text("可用余额："+c.remainMoney+"元");$("#availablePayMoney").val(c.remainMoney);}}},"json");}}}}function changePayCouponType(a){if(a==0){$("#availableCouponText").hide();}else{if(a==1){$("#availableCouponText").show();}}}function changePayScoreType(a){if(a==0){$("#availableScoreText").hide();}else{if(a==1){$("#availableScoreText").show();}}}function clearCommentsContent(){$("#comments_content").val("");}function submitComments(){var b=$("#comments_content").val();if($.trim(b)==""){alert("请输入您要留言的内容");return;}showLoading();var a=$("#siteContextPath").val();$.post(a+"/wx/comments/submit.wx",{content:b},function(c){hideLoading();if(c=="1029"){alert("页面停留过久，请重新进入");}else{if(c=="1036"){alert("加载失败，请重试");}else{if(c=="0"){alert("留言成功，感谢您的使用");clearCommentsContent();$("#pageNo").val(0);fetchNextCommentsPage();}}}});}function fetchNextCommentsPage(){showLoading();var a=$("#siteContextPath").val();var b=$("#pageNo").val();if(!b){b=0;$("#pageNo").val(b);}b=b*1+1;$.post(a+"/wx/comments/list.wx",{currentPage:b},function(c){hideLoading();if(c=="1029"){alert("页面停留过久，请重新进入");}else{if(c=="1036"){alert("加载失败，请重试");}else{if(c.indexOf("暂无留言")>0){alert("没有更多了");$("#loadMore").hide();}else{if(b==1){$("#comments_context").html(c);}else{$("#comments_context").append(c);}$("#commentsList_ctx").listview("refresh");}}}});}var slideIntervals=[];function initSlide(b,g){if($("#"+g).length==0){return;}$("#"+g).html($("#"+g+"_template").html());var e=$("body").width()-30;$("#"+g).css("width",e+"px").find("li,ul li img").css("width",e+"px");$("#"+g).next(".slide_title").css("width",e+"px");var a=$("#"+g).height();$("#"+g).find("li img").css("height",a+"px");$("#"+g).find("ul").css("width",(e*b)+"px");updateSlidePage(0,g);var d=new iScroll(g,{snap:true,momentum:true,hScrollbar:false,onScrollEnd:function(){updateSlidePage(this.currPageX,g);}});for(var c=0;c<slideIntervals.length;c++){clearInterval(slideIntervals[c]);}var f=setInterval(function(){if($("#"+g).length==0){return;}var h=$("#"+g).attr("currentPage");if(!h){h=0;$("#"+g).attr("currentPage",h);}h++;if(h>=b){h=0;}d.scrollToPage(h,0,300);},5000);slideIntervals.push(f);}function updateSlidePage(a,b){$("#"+b).attr("currentPage",a);$("#"+b).next(".slide_title").find("span[title='slide_title']").html($("#"+b).find("li img").eq(a).attr("title"));$("#"+b).next(".slide_title").find(".ui-slider-dots b").removeClass("ui-slider-dot-select");$("#"+b).next(".slide_title").find(".ui-slider-dots b").eq(a).addClass("ui-slider-dot-select");}function addToCartAtMenuDetail(a){if($("input[name='menuIdList'][value='"+a+"']").length>0){alert("此商品已经在购物车了哦");return;}addGoodsToCart(a,1);alert("加入购物车成功");}function bindFetchNexrMenu(){if($("#fetchNextPageMenuStatus").length==0){$("body").append('<input type="hidden" value="0" id="fetchNextPageMenuStatus"/>');var a=$(document).height();var b=$(window).height();$(window).scroll(function(){var c=$(this).scrollTop();if(c+b>a-200){if($("#fetchNextPageMenuStatus").val()=="0"&&$("#menu_list").is(":visible")){fetchNextMenuPage("more");}}});}}function valudateScore(){var a=$("input[name='isUsePayScore']:checked").val();if(a=="1"){var b=$("#currentRemainScore").val();var c=$("#useScoreValue").val();if(c==""){alert("请输入需要抵扣的积分");return false;}if(!validateNumber(c)){alert("请输入正确的积分");return false;}if(c*1>b){alert("您的积分不够哦，最多输入"+b);return false;}}return true;}function submitOrderComments(){var d=$("#orderCommentsContent").val();if(d.length>512){alert("评论最多512个字");return;}var b=$("#orderStarCount").val();if(b==-1){alert("请选择评分星级！");return;}var a=$("#orderCommentsOrderId").val();var f=$("#commentsNickName").val();var e={"orderId":a,"comments":d,"starCount":b,"nickName":f};var c=$("#siteContextPath").val();showLoading();$.post(c+"/wx/order/comments/submit.wx",e,function(g){hideLoading();if(g=="1"){alert("已完成的订单才能评价哦");}else{if(g=="2"){alert("该订单已经评价过了哦");}else{if(g=="3"){alert("此订单不是你的哦");}else{if(g=="0"){alert("评价成功，感谢您的支持");}}}}setTimeout(function(){$("#orderCommentsBaclBtn").click();},1500);});}function startClick(b){var a=$("#siteContextPath").val();$("#starWrap img").attr("src",a+"/template/images/star/none.png");if(b==0){$("#starWrap img").eq(0).attr("src",a+"/template/images/star/one.png");}else{if(b==1){$("#starWrap img").eq(0).attr("src",a+"/template/images/star/one.png");$("#starWrap img").eq(1).attr("src",a+"/template/images/star/one.png");}else{for(var c=0;c<=b;c++){$("#starWrap img").eq(c).attr("src",a+"/template/images/star/five.png");}}}$("#orderStarCount").val(b+1);}function loadMoreOrderComments(b,d){var c=$("#"+b).attr("page")*1;var a=$("#siteContextPath").val();showLoading();$.post(a+"/wx/order/comments/list.wx?action=weixin_14",{currentPage:c},function(e){hideLoading();if(e){if(e.indexOf("暂无评论")>-1){if(d=="shopIndex"){$("#"+b).append(e);}else{alert("暂无评论了哦");}$("#"+b+"_more").hide();}else{$("#"+b).append(e);$("#"+b).attr("page",c+1);}}});}function agreeComment(c,b,d){var a=$("#siteContextPath").val();showLoading();$.post(a+"/wx/order/comments/agree.wx",{action:c,commentsId:b},function(f){hideLoading();if(f){if(f==1){if(c==0){alert("您今天已经踩过了哦，别那么狠吧!");}else{if(c==1){alert("您今天已经赞过了哦，谢谢您的支持!");}}}else{if(f==0){if(c==0){alert("踩成功!");}else{if(c==1){alert("赞成功!");}}var e=$("#"+d).text()*1;$("#"+d).text(e+1);}}}});}function customerSignin(){showLoading();var a=$("#siteContextPath").val();$.get(a+"/wx/customer/signin.wx",function(b){hideLoading();$("#customerSignin_btn").remove();if(b=="-1"){alert("没有开启签到功能哦，或者只对会员开放！");}else{if(b=="0"){alert("签到成功！快看看有没有赠送的积分或优惠券吧");$("#todaySignin_btn").show();$("#totalSigninCount").html($("#totalSigninCount").html()*1+1);}else{if(b=="1"){alert("您今天已经签过到了哦，明天再来吧！");}}}});}